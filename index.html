<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WaveTable Generator [Final Master]</title>
<style>
    /* UI Design: Light Theme */
    :root { 
        --bg: #f4f6f8; --panel: #ffffff; --text: #2c3e50; --border: #dae1e7; 
        --accent: #e91e63; --accent-hover: #c2185b; 
        --slot-bg: #fdfdfd; --active-slot: #fce4ec;
        --ok: #27ae60; --warn: #e74c3c;
    }
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 1000px; margin: 0 auto; line-height: 1.5; }
    
    .header { border-bottom: 3px solid var(--accent); padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    h1 { margin: 0; font-size: 1.5rem; color: var(--text); display: flex; align-items: center; gap: 10px; }
    .tag { font-size: 0.8rem; background: var(--ok); color: #fff; padding: 4px 8px; border-radius: 4px; font-weight: normal; }
    .subtitle { font-size: 0.9rem; color: #666; font-weight: normal; margin-left: 10px; }

    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
    .tool-btn { background: #fff; border: 1px solid #ccc; color: #555; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 0.85rem; transition: 0.2s; }
    .tool-btn:hover { background: #f0f0f0; transform: translateY(-1px); border-color: var(--accent); color: var(--accent); }
    
    .grid { display: grid; grid-template-columns: 1fr 1.4fr; gap: 20px; }
    .panel { background: var(--panel); padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid var(--border); }
    
    label { font-weight: bold; font-size: 0.85rem; display: block; margin-bottom: 6px; color: #555; }
    select { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; background: #fff; font-weight: bold; }
    
    .info-box { background: #eef6fc; border-left: 4px solid var(--accent); padding: 10px; font-size: 0.85rem; color: #555; margin-top: 8px; border-radius: 0 4px 4px 0; min-height: 3em; }

    .mod-slot { background: var(--slot-bg); padding: 12px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 6px; transition: 0.2s; }
    .mod-slot.active { background: var(--active-slot); border-left: 4px solid var(--accent); border-color: #f8bbd0; }
    .mod-desc { font-size: 0.8rem; color: #666; margin: 5px 0; font-style: italic; min-height: 1.2em; display: block; }
    
    input[type=range] { width: 100%; height: 6px; background: #ddd; border-radius: 3px; -webkit-appearance: none; outline: none; cursor: pointer; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: var(--accent); border-radius: 50%; transition: 0.2s; }
    input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }

    canvas { width: 100%; height: 140px; background: #222; border-radius: 4px; margin-bottom: 10px; border: 1px solid #444; }
    
    .btn-group { display: flex; gap: 10px; margin-top: 10px; }
    .main-btn { flex: 1; padding: 15px; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.2s; color: #fff; }
    .preview-btn { background: #34495e; }
    .preview-btn:hover { background: #2c3e50; }
    .preview-btn.playing { background: var(--ok); animation: pulse 1s infinite; }
    
    .dl-btn { background: var(--accent); }
    .dl-btn:hover { background: var(--accent-hover); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(233, 30, 99, 0.3); }
    .dl-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
    
    /* LFO Checkbox */
    .lfo-wrap { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; font-weight: bold; color: var(--accent); cursor: pointer; float: right; }
    .lfo-wrap input { width: auto; height: auto; accent-color: var(--accent); }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #777; font-size: 0.8rem; text-align: center; }

    @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } .header { flex-direction: column; align-items: flex-start; } }
</style>
</head>
<body>

<div class="header">
    <h1>
        WaveTable Generator 
        <span class="tag">Final Master</span>
    </h1>
    <div class="toolbar">
        <button class="tool-btn" onclick="setPreset('growl')">ğŸ¦– Growl</button>
        <button class="tool-btn" onclick="setPreset('pad')">ğŸ¹ Pad</button>
        <button class="tool-btn" onclick="setPreset('acid')">ğŸ’Š Acid</button>
        <button class="tool-btn" onclick="randomize()">ğŸ² Random</button>
        <button class="tool-btn" onclick="resetAll()">ğŸ›‘ Reset</button>
    </div>
</div>

<div class="grid">
    <!-- Left Column -->
    <div>
        <div class="panel">
            <label>1. åŸºæœ¬æ³¢å½¢ã‚’é¸æŠ (Base Waveform)</label>
            <select id="catSelect" onchange="updateWaveList()" style="margin-bottom:10px; background:#f9f9f9;"></select>
            <select id="waveSelect" onchange="updateWaveDesc(); updateState();"></select>
            <div id="waveDesc" class="info-box">--</div>
        </div>

        <div class="panel">
            <label>3. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ & ä¿å­˜</label>
            <canvas id="scope" width="600" height="200"></canvas>
            
            <div style="margin-bottom:5px; overflow:hidden;">
                <label style="float:left; color:#e91e63;">Wavetable Pos:</label>
                <label class="lfo-wrap">
                    <input type="checkbox" id="lfoToggle" onchange="updateState()"> Auto LFO
                </label>
            </div>
            <!-- Pos Slider -->
            <input type="range" id="posSlider" min="0" max="100" value="0" style="width:100%; background:#e91e63; margin-bottom:15px;" oninput="updateState()">

            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                <label style="margin:0;">éŸ³é‡ (Vol):</label>
                <input type="range" id="volSlider" min="0" max="100" value="70" style="width:60%">
            </div>

            <div class="btn-group">
                <button id="previewBtn" class="main-btn preview-btn" onclick="togglePreview()">ğŸ”Š è©¦è´ã™ã‚‹ (Preview)</button>
                <button id="dlBtn" class="main-btn dl-btn" onclick="generateWav()">ğŸ’¾ WAVã‚’ä¿å­˜ (Download)</button>
            </div>
            
            <div id="status" style="text-align:center; font-size:0.8rem; color:#888; margin-top:5px;">Ready. (1024 Harmonics / 8x Oversampling)</div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="panel">
        <label>2. ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¨­å®š (Modulation Rack)</label>
        <div id="modContainer"></div>
    </div>
</div>

<div class="footer">
    <p><strong>Unofficial Tool for Vital / Serum / Phase Plant</strong></p>
    <p>Output Format: 2048 samples x 256 frames (32-bit Float / 8x Oversampling).</p>
  <p><strong>ã€å…è²¬äº‹é …ã€‘</strong></p>

<p>
æœ¬ãƒ„ãƒ¼ãƒ«ãŠã‚ˆã³åŒæ¢±ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¯ç„¡ä¿è¨¼ã§æä¾›ã•ã‚Œã‚‹ã‚‚ã®ã§ã‚ã‚Šã€ãã®æ­£ç¢ºæ€§ãƒ»å®‰å…¨æ€§ãƒ»æœ‰ç”¨æ€§ã«ã¤ã„ã¦ã„ã‹ãªã‚‹ä¿è¨¼ã‚‚è¡Œã„ã¾ã›ã‚“ã€‚
æœ¬ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨ä¸­ã«ã¯ã€é«˜ãƒ¬ãƒ™ãƒ«ã®éŸ³é‡ã‚„çªç™ºçš„ãªãƒ”ãƒ¼ã‚¯ã€æ¥µç«¯ãªå¸¯åŸŸã®ä¿¡å·ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³ã‚„ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚’ç”¨ã„ã‚‹éš›ã¯ã€å¿…ãšéŸ³é‡ã‚’ååˆ†ã«ä¸‹ã’ãŸçŠ¶æ…‹ã‹ã‚‰å†ç”Ÿã‚’é–‹å§‹ã—ã€å¾ã€…ã«èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
ã¾ãŸã€ãƒªãƒŸãƒƒã‚¿ãƒ¼ã‚„ãƒ¡ãƒ¼ã‚¿ãƒ¼é¡ã‚’ä½µç”¨ã—ã€è€³ãŠã‚ˆã³ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒ»ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªæ©Ÿå™¨ã®ä¿è­·ã«ååˆ†ã”æ³¨æ„ãã ã•ã„ã€‚
</p>

<p>
æœ¬ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨ã«ã‚ˆã‚Šç”Ÿã˜ãŸã„ã‹ãªã‚‹æå®³ï¼ˆè´è¦šã¸ã®å½±éŸ¿ã€è€³é³´ã‚Šç­‰ã®å¥åº·è¢«å®³ã€ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒ»ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªæ©Ÿå™¨ãƒ»ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®æ•…éšœã‚„ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ã€ãã®ä»–ã®é‡‘éŠ­çš„ãƒ»ç²¾ç¥çš„æå®³ã‚’å«ã¿ã¾ã™ï¼‰ã«ã¤ã„ã¦ã‚‚ã€ä½œè€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
ã”åˆ©ç”¨è€…è‡ªèº«ã®åˆ¤æ–­ã¨è‡ªå·±è²¬ä»»ã«ãŠã„ã¦ã”ä½¿ç”¨ãã ã•ã„ã€‚
</p>

<p>
ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã”è‡ªèº«ã®è²¬ä»»ã«ãŠã„ã¦ã”ä½¿ç”¨ãã ã•ã„ã€‚  
<a href="WTGE Manual.pdf" target="_blank" rel="noopener noreferrer">
  ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆPDFï¼‰ã‚’é–‹ã
</a>
</p>

<p>License: MIT (Free to use and distribute)</p>

</div>

<script>
// =========================================================
// 1. DSP KERNEL: 8x OVERSAMPLING & HIGH-PRECISION MATH
// =========================================================
const PI = Math.PI;
const PI2 = Math.PI * 2;
const OVERSAMPLE = 8; // 8x Oversampling for pristine quality

// --- Helper Functions ---

// Safe Sinc Function
const sinc = (x) => (Math.abs(x) < 0.001) ? 1.0 : Math.sin(x) / x;

// Safe Phase Wrap (0.0 to 1.0)
// Math.floor handles negative numbers correctly unlike %
const fract = (x) => x - Math.floor(x);

// Lanczos Sigma Factor (Reduces Gibbs Phenomenon)
const sigma = (k, m) => k === 0 ? 1.0 : Math.sin(PI * k / m) / (PI * k / m);

// Schroeder Phase (Reduces Crest Factor / Improves Loudness)
const getSchroederPhase = (k, count) => -PI * k * (k - 1) / count;

// Chebyshev Polynomials
const cheby = (n, x) => {
    if(n===0) return 1;
    if(n===1) return x;
    return 2*x * cheby(n-1, x) - cheby(n-2, x);
};

// Additive Synthesis Engine (The Heart of High Quality)
// Default count raised to 1024 (Nyquist for 2048 samples)
const additive = (t, type, count=1024) => {
    let v = 0;
    
    // Schroeder Phase formula helps distribute energy over time, avoiding spikes
    const getPhase = (k) => -PI * k * (k - 1) / count;

    if (type === 'saw') { 
        for(let k=1; k <= count; k++) {
            v += (Math.sin(t * PI2 * k + getPhase(k)) / k) * sigma(k, count); 
        }
        return v * 0.6; 
    }
    if (type === 'square') { 
        for(let k=1; k <= count; k+=2) {
            v += (Math.sin(t * PI2 * k + getPhase(k)) / k) * sigma(k, count); 
        }
        return v * 0.7; 
    }
    if (type === 'tri') { 
        for(let k=1; k <= count; k+=2) {
            v += Math.cos(t * PI2 * k) / (k*k); 
        }
        return v * 0.8; 
    }
    if (type === 'buzz') {
        for(let k=1; k <= 128; k++) { // Limited to avoid harsh noise, but still rich
            v += Math.sin(t * PI2 * k + getPhase(k)) * sigma(k, 128);
        }
        return v * 0.05;
    }
    return 0;
};

// --- WAVEFORM LIBRARY (50 Types / Final Master) ---
const WAVE_LIB = {
    "ã€åŸºæœ¬ã€‘ã‚¢ãƒŠãƒ­ã‚° / ãƒ™ãƒ¼ã‚·ãƒƒã‚¯": [
        { name: "Pure Sine (ç´”ç²‹ã‚µã‚¤ãƒ³æ³¢)", func: (t)=>Math.sin(t*PI2), desc: "æ­ªã¿ã®ãªã„ç´”ç²‹ãªã‚µã‚¤ãƒ³æ³¢ã§ã™ã€‚ã‚µãƒ–ãƒ™ãƒ¼ã‚¹ã‚„FMã®ã‚­ãƒ£ãƒªã‚¢ï¼ˆåœŸå°ï¼‰ã¨ã—ã¦æœ€é©ã§ã™ã€‚" },
        { name: "High-Res Saw (é«˜éŸ³è³ªãƒã‚³ã‚®ãƒªæ³¢)", func: (t)=>additive(t,'saw'), desc: "ã‚·ãƒ¥ãƒ¬ãƒ¼ãƒ€ãƒ¼ä½ç›¸ã‚’ç”¨ã„ãŸåŠ ç®—åˆæˆã«ã‚ˆã‚‹ã€éŸ³åœ§ãŒé«˜ãã‚¨ã‚¤ãƒªã‚¢ã‚·ãƒ³ã‚°ã®ãªã„æœ€é«˜å“è³ªã®ãƒã‚³ã‚®ãƒªæ³¢ã§ã™ã€‚" },
        { name: "High-Res Square (é«˜éŸ³è³ªçŸ©å½¢æ³¢)", func: (t)=>additive(t,'square'), desc: "å€éŸ³åŠ ç®—åˆæˆã«ã‚ˆã‚‹ã€ãƒ‡ã‚¸ã‚¿ãƒ«è‡­ã•ã®ãªã„å¤ªãã‚¯ãƒªã‚¢ãªçŸ©å½¢æ³¢ã§ã™ã€‚" },
        { name: "BL Triangle (é«˜éŸ³è³ªä¸‰è§’æ³¢)", func: (t)=>additive(t,'tri'), desc: "é«˜ç²¾åº¦ãªä¸‰è§’æ³¢ã€‚ãƒ•ãƒ«ãƒ¼ãƒˆã‚„ä¸¸ã„ãƒªãƒ¼ãƒ‰éŸ³ã€ã‚µãƒ–ãƒ™ãƒ¼ã‚¹ã«é©ã—ã¦ã„ã¾ã™ã€‚" },
        { name: "BL Pulse 10% (ãƒ‘ãƒ«ã‚¹æ³¢ ç´°ã‚)", func: (t)=>{let v=0;for(let k=1;k<128;k++)v+=Math.sin(k*Math.PI*0.1)/k*Math.cos(k*t*PI2)*sigma(k,128);return v*0.7}, desc: "ãƒ‡ãƒ¥ãƒ¼ãƒ†ã‚£æ¯”10%ã®ãƒ‘ãƒ«ã‚¹æ³¢ã€‚é¼»ã«ã‹ã‹ã£ãŸé‹­ã„éŸ³ã§ã€Acid Bassã‚„ãƒãƒƒãƒ—ãƒãƒ¥ãƒ¼ãƒ³ã«å¿…é ˆã§ã™ã€‚" },
        { name: "BL Pulse 25% (ãƒ‘ãƒ«ã‚¹æ³¢ å¤ªã‚)", func: (t)=>{let v=0;for(let k=1;k<128;k++)v+=Math.sin(k*Math.PI*0.25)/k*Math.cos(k*t*PI2)*sigma(k,128);return v*0.7}, desc: "ãƒ‡ãƒ¥ãƒ¼ãƒ†ã‚£æ¯”25%ã®ãƒ‘ãƒ«ã‚¹æ³¢ã€‚çŸ©å½¢æ³¢ã‚ˆã‚Šå°‘ã—ç´°ãã€ç‹¬ç‰¹ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æŒã¤ã‚¯ãƒ©ã‚·ãƒƒã‚¯ãªã‚·ãƒ³ã‚»éŸ³ã§ã™ã€‚" },
        { name: "Soft Saw (Moogé¢¨)", func: (t)=>Math.sin(t*PI2)-0.5*Math.sin(t*PI2*2)-0.3*Math.sin(t*PI2*3), desc: "ä½æ¬¡å€éŸ³ã®ã¿ã§æ§‹æˆã•ã‚ŒãŸæŸ”ã‚‰ã‹ã„ã‚½ãƒ¼æ³¢ã€‚Moogç­‰ã®ã‚¢ãƒŠãƒ­ã‚°ã‚·ãƒ³ã‚»ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é€šã—ãŸã‚ˆã†ãªéŸ³ã§ã™ã€‚" },
        { name: "Odd Harmonics Saw (å¥‡æ•°å€éŸ³Saw)", func: (t)=>{let v=0;for(let k=1;k<64;k+=2)v+=Math.sin(t*PI2*k)/k;return v*0.6}, desc: "å¥‡æ•°å€éŸ³ã®ã¿ã‚’æŒã¤ãƒã‚³ã‚®ãƒªæ³¢ã€‚çŸ©å½¢æ³¢ã«è¿‘ã„ã§ã™ãŒã€ã‚ˆã‚Šã‚¨ãƒƒã‚¸ã®åŠ¹ã„ãŸç‹¬ç‰¹ã®éŸ¿ãã§ã™ã€‚" },
        { name: "Buzz Saw (å…¨å€éŸ³ãƒã‚³ã‚®ãƒª)", func: (t)=>additive(t,'buzz', 64), desc: "å…¨å€éŸ³ã‚’å‡ç­‰ãªå¼·ã•ã§åŠ ç®—ã—ãŸæ”»æ’ƒçš„ãªæ³¢å½¢ã€‚ã‚¢ãƒŠãƒ­ã‚°ã‚·ãƒ³ã‚»ã®ã€ŒRawã€ãªéŸ³ã§ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®æ›ã‹ã‚ŠãŒæŠœç¾¤ã§ã™ã€‚" },
        { name: "Square-Saw (ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰)", func: (t)=>{let v=0;for(let k=1;k<64;k++)v+=Math.sin(t*PI2*k)/(k*(k%2==0?2:1));return v*0.6}, desc: "å¶æ•°å€éŸ³ã‚’åŠåˆ†ã ã‘å‰Šã£ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ³¢å½¢ã€‚çŸ©å½¢æ³¢ã®ä¸­ç©ºæ„Ÿã¨ãƒã‚³ã‚®ãƒªæ³¢ã®å¤ªã•ã‚’ã„ã„ã¨ã“å–ã‚Šã—ãŸéŸ³ã§ã™ã€‚" }
    ],
    "ã€æ­ªã¿ã€‘ã‚µãƒãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ / ã‚·ã‚§ã‚¤ãƒ—": [
        { name: "Hard Clip (ãƒãƒ¼ãƒ‰ã‚¯ãƒªãƒƒãƒ—)", func: (t)=>Math.max(Math.min(Math.sin(t*PI2)*3,1),-1), desc: "ã‚µã‚¤ãƒ³æ³¢ã®ä¸Šä¸‹ã‚’ãƒãƒƒã‚µãƒªåˆ‡ã‚Šå–ã£ãŸæ³¢å½¢ã§ã™ã€‚éŸ³åœ§ãŒé«˜ãã€æ¿€ã—ã„ãƒ€ãƒ–ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ™ãƒ¼ã‚¹ã«å‘ã„ã¦ã„ã¾ã™ã€‚" },
        { name: "Tube Sat (çœŸç©ºç®¡)", func: (t)=>Math.tanh(Math.sin(t*PI2)*5), desc: "çœŸç©ºç®¡ã‚¢ãƒ³ãƒ—ã‚’é€šã—ãŸã‚ˆã†ãªã€æ¸©ã‹ãç²˜ã‚Šã®ã‚ã‚‹æ­ªã¿ã§ã™ã€‚å€éŸ³ãŒè±Šã‹ã§å¤ªã„éŸ³ã«ãªã‚Šã¾ã™ã€‚" },
        { name: "Donk Fold (FMãƒ™ãƒ¼ã‚¹)", func: (t)=>Math.sin(Math.sin(t*PI2)*3), desc: "ã‚µã‚¤ãƒ³æ³¢ã®ä¸­ã«ã‚µã‚¤ãƒ³æ³¢ã‚’æŠ˜ã‚Šè¾¼ã‚“ã æ³¢å½¢ã§ã™ã€‚FMéŸ³æºã®ã‚ˆã†ãªé‡‘å±çš„ãªéŸ¿ãã‚’æŒã¤ã€ŒDonk Bassã€ã«ãªã‚Šã¾ã™ã€‚" },
        { name: "Quadratic Shaper (2ä¹—)", func: (t)=>Math.pow(Math.sin(t*PI2),2)*2-1, desc: "å…¥åŠ›ä¿¡å·ã‚’äºŒä¹—ã—ãŸæ³¢å½¢ã€‚å¶æ•°æ¬¡å€éŸ³ãŒå¼·èª¿ã•ã‚Œã€ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šã®æˆåˆ†ãŒå¼·ãå‡ºã¾ã™ã€‚" },
        { name: "Soft Rectifier (ã‚½ãƒ•ãƒˆæ•´æµ)", func: (t)=>Math.sqrt(Math.abs(Math.sin(t*PI2)))*2-1, desc: "ã‚µã‚¤ãƒ³æ³¢ã®çµ¶å¯¾å€¤ã®å¹³æ–¹æ ¹ã€‚å…¨æ³¢æ•´æµã«ä¼¼ã¦ã„ã¾ã™ãŒã€ã‚ˆã‚Šå¤ªãæ»‘ã‚‰ã‹ãªå€éŸ³ã‚’æŒã¡ã¾ã™ã€‚" },
        { name: "Fuzz Wave (ãƒ•ã‚¡ã‚º)", func: (t)=>cheby(3, Math.sin(t*PI2))*0.7 + 0.3*cheby(9, Math.sin(t*PI2)), desc: "ä½æ¬¡ã¨é«˜æ¬¡ã®å¤šé …å¼æ­ªã¿ã‚’æ··åˆã€‚ã‚®ã‚¿ãƒ¼ã®ãƒ•ã‚¡ã‚ºã‚¨ãƒ•ã‚§ã‚¯ã‚¿ãƒ¼ã®ã‚ˆã†ãªç²’ã®ç²—ã„æ­ªã¿ã§ã™ã€‚" },
        { name: "Sine Fold (æŠ˜ã‚Šè¿”ã—)", func: (t)=>Math.sin(Math.sin(t*PI2)*3), desc: "ã‚µã‚¤ãƒ³æ³¢ã‚’ã‚µã‚¤ãƒ³æ³¢ã§æŠ˜ã‚Šè¿”ã—ãŸæ³¢å½¢ã€‚FMéŸ³æºã®ã‚ˆã†ãªé‡‘å±çš„ã§è¤‡é›‘ãªéŸ¿ãã§ã™ã€‚" },
        { name: "Tri Fold (ä¸‰è§’æ³¢æŠ˜ã‚Šè¿”ã—)", func: (t)=>Math.sin(additive(t,'tri')*4), desc: "ä¸‰è§’æ³¢ã‚’ã‚¦ã‚§ãƒ¼ãƒ–ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«é€šã—ãŸéŸ³ã€‚Sine Foldã‚ˆã‚Šé‹­ãã€æ”»æ’ƒçš„ãªå€éŸ³æˆåˆ†ã‚’æŒã¡ã¾ã™ã€‚" },
        { name: "Asymmetric Dist (éå¯¾ç§°)", func: (t)=>Math.sin(t*PI2) + 0.5*Math.pow(Math.sin(t*PI2),2), desc: "éå¯¾ç§°ãªæ­ªã¿ã‚’åŠ ãˆãŸæ³¢å½¢ã€‚çœŸç©ºç®¡ã‚¢ãƒ³ãƒ—ã®ã‚ˆã†ãªã€å¶æ•°å€éŸ³ã‚’å«ã‚€æ¸©ã‹ã„ã‚µãƒãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚" },
        { name: "Rectified (åŠæ³¢æ•´æµ)", func: (t)=>Math.max(Math.sin(t*PI2),0), desc: "ãƒã‚¤ãƒŠã‚¹å´ã‚’ã‚«ãƒƒãƒˆã—ãŸæ³¢å½¢ã§ã™ã€‚ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šã®éŸ³ãŒé‡ãªã£ãŸã‚ˆã†ãªç‹¬ç‰¹ã®èŠ¯ã®ã‚ã‚‹éŸ³ã§ã™ã€‚" }
    ],
    "ã€é‡‘å±ã€‘FM / ãƒ¡ã‚¿ãƒªãƒƒã‚¯": [
        { name: "Simple FM (åŸºæœ¬)", func: (t)=>Math.sin(t*PI2+Math.sin(t*PI2)), desc: "1:1ã®æ¯”ç‡ã§å¤‰èª¿ã—ãŸåŸºæœ¬ã®FMã‚µã‚¦ãƒ³ãƒ‰ã§ã™ã€‚å¤ªãã€å°‘ã—é‡‘å±çš„ãªãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’ä½œã‚‹ã®ã«æœ€é©ã§ã™ã€‚" },
        { name: "Octave FM (ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–)", func: (t)=>Math.sin(t*PI2+Math.sin(t*PI2*2)), desc: "ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šã®å€éŸ³ã§å¤‰èª¿ã—ãŸFMã§ã™ã€‚é‹­ãçªãåˆºã•ã‚‹ã‚ˆã†ãªã€ç¡¬ã„é‡‘å±éŸ³ãŒç‰¹å¾´ã§ã™ã€‚" },
        { name: "Power FM (5åº¦)", func: (t)=>Math.sin(t*PI2*2+Math.sin(t*PI2*3)), desc: "å®Œå…¨5åº¦ã®é–¢ä¿‚ã§å¤‰èª¿ã—ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ¬ã‚­ã‚®ã‚¿ãƒ¼ã®ãƒ‘ãƒ¯ãƒ¼ã‚³ãƒ¼ãƒ‰ã®ã‚ˆã†ãªã€åšã¿ã®ã‚ã‚‹éŸ¿ãã§ã™ã€‚" },
        { name: "Bell FM (ãƒ™ãƒ«éŸ³)", func: (t)=>Math.sin(t*PI2+Math.sin(t*PI2*5.4)), desc: "éæ•´æ•°å€éŸ³ã‚’å«ã‚€FMã§ã™ã€‚éŸ³ç¨‹æ„ŸãŒæ›–æ˜§ãªã€é˜ï¼ˆãƒ™ãƒ«ï¼‰ã‚„ã‚´ãƒ³ã‚°ã®ã‚ˆã†ãªä¸æ°—å‘³ãªé‡‘å±éŸ³ã«ãªã‚Šã¾ã™ã€‚" },
        { name: "Feedback (ãƒã‚¤ã‚ºFM)", func: (t)=>Math.sin(t*PI2+Math.sin(t*PI2)*3), desc: "è‡ªåˆ†è‡ªèº«ã§å¼·ãå¤‰èª¿ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰ã—ãŸéŸ³ã§ã™ã€‚å´©å£Šã—ãŸã‚ˆã†ãªæ¿€ã—ã„ãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºçš„ãªFMã§ã™ã€‚" },
        { name: "Self FM (è‡ªå·±å¤‰èª¿)", func: (t)=>Math.sin(t*PI2 + Math.sin(t*PI2)*2), desc: "è‡ªåˆ†è‡ªèº«ã§å‘¨æ³¢æ•°å¤‰èª¿ã‚’ã‹ã‘ãŸæ³¢å½¢ã€‚ãƒã‚¤ã‚ºã‚’å«ã‚“ã æ¿€ã—ã„FMã‚µã‚¦ãƒ³ãƒ‰ã§ã™ã€‚" },
        { name: "PD Saw (ä½ç›¸å¤‰èª¿Saw)", func: (t)=>Math.sin((t+0.5*Math.sin(t*PI2))*PI2), desc: "ä½ç›¸æ­ªã¿ï¼ˆPDï¼‰ã«ã‚ˆã£ã¦ã‚µã‚¤ãƒ³æ³¢ã‚’ãƒã‚³ã‚®ãƒªæ³¢ã«è¿‘ã¥ã‘ãŸéŸ³ã€‚Casio CZã‚·ãƒªãƒ¼ã‚ºé¢¨ã®è³ªæ„Ÿã§ã™ã€‚" },
        { name: "PD Double Peak (2ãƒ”ãƒ¼ã‚¯)", func: (t)=>Math.sin(t*PI2 + Math.sin(4*t*PI2)), desc: "1å‘¨æœŸã®ä¸­ã«2ã¤ã®ãƒ”ãƒ¼ã‚¯ã‚’æŒã¤PDæ³¢å½¢ã€‚ãƒ•ã‚©ãƒ«ãƒãƒ³ãƒˆã®ã‚ˆã†ãªå…±é³´æ„ŸãŒã‚ã‚Šã¾ã™ã€‚" },
        { name: "Kink Phase (ãƒ“ãƒ¨ãƒ¼ãƒ³)", func: (t)=>Math.sin(Math.pow(t, 2.5)*PI2), desc: "ä½ç›¸ã®èª­ã¿å‡ºã—é€Ÿåº¦ã‚’æŒ‡æ•°é–¢æ•°çš„ã«æ­ªã¾ã›ãŸéŸ³ã€‚ç‹¬ç‰¹ã®ã€Œãƒ“ãƒ¨ãƒ¼ãƒ³ã€ã¨ã„ã†ç²˜ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚" },
        { name: "Feedback Square (çŸ©å½¢FM)", func: (t)=>{let s=Math.sin(t*PI2); return Math.sin(t*PI2 + s*s*5)}, desc: "äºŒä¹—ã—ãŸã‚µã‚¤ãƒ³æ³¢ã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¤‰èª¿ã€‚äºˆæ¸¬ä¸èƒ½ãªå€éŸ³å¤‰åŒ–ã‚’ã™ã‚‹ã‚«ã‚ªã‚¹ãªéŸ³ã§ã™ã€‚" }
    ],
    "ã€å’ŒéŸ³ã€‘ã‚³ãƒ¼ãƒ‰ / ã‚ªãƒ«ã‚¬ãƒ³": [
        { name: "Major Chord (ãƒ¡ã‚¸ãƒ£ãƒ¼)", func: (t)=>(Math.sin(t*PI2*4) + Math.sin(t*PI2*5) + Math.sin(t*PI2*6))/3, desc: "ã€ç´”æ­£å¾‹ã€‘4:5:6ã®å€éŸ³ã‚’ä½¿ç”¨ã—ãŸãƒ¡ã‚¸ãƒ£ãƒ¼ã‚³ãƒ¼ãƒ‰ã€‚å”¸ã‚Šã®ãªã„ã€é€ãé€šã‚‹ã‚ˆã†ãªç¾ã—ã„å’ŒéŸ³ã§ã™ã€‚" },
        { name: "Minor Chord (ãƒã‚¤ãƒŠãƒ¼)", func: (t)=>(Math.sin(t*PI2*10) + Math.sin(t*PI2*12) + Math.sin(t*PI2*15))/3, desc: "ã€ç´”æ­£å¾‹ã€‘10:12:15ã®å€éŸ³ã‚’ä½¿ç”¨ã—ãŸãƒã‚¤ãƒŠãƒ¼ã‚³ãƒ¼ãƒ‰ã€‚æ¿ã‚Šã®ãªã„ã€æ‚²ã—ã’ã§é€æ˜æ„Ÿã®ã‚ã‚‹éŸ¿ãã§ã™ã€‚" },
        { name: "Maj7 Chord (ãƒ¡ã‚¸ãƒ£ãƒ¼7)", func: (t)=>(Math.sin(t*PI2*8) + Math.sin(t*PI2*10) + Math.sin(t*PI2*12) + Math.sin(t*PI2*15))/4, desc: "ã€ç´”æ­£å¾‹ã€‘Root, M3, 5th, M7th ã‚’å«ã‚€ãŠæ´’è½ãªå’ŒéŸ³ã€‚ã‚¸ãƒ£ã‚ºã‚„Lo-Fi HipHopã«æœ€é©ãªæµ®éŠæ„Ÿã®ã‚ã‚‹éŸ¿ãã€‚" },
        { name: "Min7 Chord (ãƒã‚¤ãƒŠãƒ¼7)", func: (t)=>(Math.sin(t*PI2*10) + Math.sin(t*PI2*12) + Math.sin(t*PI2*15) + Math.sin(t*PI2*18))/4, desc: "ã€ç´”æ­£å¾‹ã€‘Root, m3, 5th, m7th ã®æ§‹æˆã€‚ãƒã‚¦ã‚¹ã‚„ãƒ†ã‚¯ãƒã®ã‚¹ã‚¿ãƒ–ã«æœ€å¼·ã®ã€æ·±ã¿ã®ã‚ã‚‹éƒ½ä¼šçš„ãªã‚³ãƒ¼ãƒ‰ã€‚" },
        { name: "Sus4 Chord (ã‚µã‚¹ãƒ•ã‚©ãƒ¼)", func: (t)=>(Math.sin(t*PI2*6) + Math.sin(t*PI2*8) + Math.sin(t*PI2*9))/3, desc: "ã€ç´”æ­£å¾‹ã€‘Root, 4th, 5thã€‚è§£æ±ºã‚’å¾…ã¤ã‚ˆã†ãªã€ç·Šå¼µæ„Ÿã¨å®‡å®™çš„ãªåºƒãŒã‚Šã‚’æ„Ÿã˜ã‚‹ãƒˆãƒ©ãƒ³ã‚¹å‘ã‘å’ŒéŸ³ã€‚" },
        { name: "Drawbar Organ (ã‚ªãƒ«ã‚¬ãƒ³)", func: (t)=>Math.sin(t*PI2)+.5*Math.sin(t*PI2*2)+.3*Math.sin(t*PI2*3), desc: "ãƒãƒ¢ãƒ³ãƒ‰ã‚ªãƒ«ã‚¬ãƒ³ã®ãƒ‰ãƒ­ãƒ¼ãƒãƒ¼ã‚’å¼•ã„ãŸã‚ˆã†ãªéŸ³ã§ã™ã€‚ãƒã‚¦ã‚¹ã‚„ã‚¸ãƒ£ã‚ºã§ä½¿ãˆã‚‹ä¼çµ±çš„ãªã‚ªãƒ«ã‚¬ãƒ³ã‚µã‚¦ãƒ³ãƒ‰ã€‚" },
        { name: "Hollow (æœ¨ç®¡é¢¨)", func: (t)=>Math.sin(t*PI2)+Math.sin(t*PI2*3)/3+Math.sin(t*PI2*5)/5, desc: "å¥‡æ•°å€éŸ³ã®ã¿ã‚’åŠ ç®—ã—ãŸéŸ³ã§ã™ã€‚çŸ©å½¢æ³¢ã«ä¼¼ã¦ã„ã¾ã™ãŒã€ã‚ˆã‚ŠæŸ”ã‚‰ã‹ãã€ä¸­èº«ãŒç©ºæ´ã®æœ¨ç®¡æ¥½å™¨ã®ã‚ˆã†ãªéŸ³ãŒã—ã¾ã™ã€‚" },
        { name: "Octave Stack (ãƒ‘ãƒƒãƒ‰ç”¨)", func: (t)=>Math.sin(t*PI2)+.5*Math.sin(t*PI2*2)+.25*Math.sin(t*PI2*4), desc: "3ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–åˆ†ã®ã‚µã‚¤ãƒ³æ³¢ã‚’é‡ã­ãŸéŸ³ã§ã™ã€‚å£®å¤§ãªãƒ‘ãƒƒãƒ‰ã‚„ã€EDMã®ãƒªãƒ¼ãƒ‰éŸ³ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ä½¿ãˆã¾ã™ã€‚" },
        { name: "Liquid Saw (æ¶²ä½“Saw)", func: (t)=>Math.sin(t*PI2)+Math.sin(t*PI2*2)/2+Math.sin(t*PI2*3)/3, desc: "å€éŸ³ã‚’è¶³ã—ã¦ä½œã£ãŸæ“¬ä¼¼çš„ãªã‚½ãƒ¼æ³¢ã§ã™ã€‚æœ¬ç‰©ã®ã‚½ãƒ¼æ³¢ã‚ˆã‚Šæ»‘ã‚‰ã‹ã§ã€ã€Œæ¶²ä½“çš„ã€ãªè³ªæ„Ÿã®éŸ³ã§ã™ã€‚" },
        { name: "Spectral Cluster (ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼)", func: (t)=>Math.sin(t*PI2) + 0.3*Math.sin(1.1*t*PI2) + 0.2*Math.sin(1.2*t*PI2), desc: "å‘¨æ³¢æ•°ãŒè¿‘ã„è¤‡æ•°ã®ã‚µã‚¤ãƒ³æ³¢ã®é›†åˆã€‚ã‚³ãƒ¼ãƒ©ã‚¹ãŒã‹ã‹ã£ãŸã‚ˆã†ãªã€ã†ã­ã‚Šã®ã‚ã‚‹æŒç¶šéŸ³ã§ã™ã€‚" }
    ],
    "ã€ç‰¹æ®Šã€‘å£° / æ•°å­¦ / ãƒ‡ã‚¸ã‚¿ãƒ«": [
        { name: "Hyper Saw (ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚½ãƒ¼)", func: (t)=>{let v=0; const n=7; for(let i=0; i<n; i++){ let p=t+i*0.61803398875; v+=(1-2*fract(p)); } return v*0.2;}, desc: "7ã¤ã®ãƒã‚³ã‚®ãƒªæ³¢ã®ä½ç›¸ã‚’é»„é‡‘æ¯”ã§åˆ†æ•£ã•ã›ã€éŸ³åœ§ã‚’æœ€é©åŒ–ã—ãŸã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚½ãƒ¼ã€‚1ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§åˆ†åšã„éŸ³ãŒå‡ºã¾ã™ã€‚" },
        { name: "Real Vocal 'Ah' (å£°ã‚¢ãƒ¼)", func: (t)=>{let x=fract(t); return Math.sin(x*PI2*4)*Math.exp(-2*x) + Math.sin(x*PI2*8)*Math.exp(-4*x)*0.5 + Math.sin(x*PI2*12)*Math.exp(-8*x)*0.3}, desc: "ã€NEWã€‘F1/F2/F3å…±é³´ã‚’æŒã¤ãƒªã‚¢ãƒ«ãªæ¯éŸ³ã€Œã‚¢ãƒ¼ã€ã€‚æœ‰æ©Ÿçš„ã§å¤ªã„å£°ã€‚" },
        { name: "Real Vocal 'Ee' (å£°ã‚¤ãƒ¼)", func: (t)=>{let x=fract(t); return Math.sin(x*PI2*3)*Math.exp(-1.5*x) + Math.sin(x*PI2*20)*Math.exp(-6*x)*0.4 + Math.sin(x*PI2*28)*Math.exp(-10*x)*0.2}, desc: "ã€NEWã€‘é«˜åŸŸã®å…±é³´ãŒç‰¹å¾´çš„ãªæ¯éŸ³ã€Œã‚¤ãƒ¼ã€ã€‚æŠœã‘ã®è‰¯ã„æ˜ã‚‹ã„å£°è³ªã€‚" },
        { name: "Real Vocal 'Oo' (å£°ã‚¦ãƒ¼)", func: (t)=>{let x=fract(t); return Math.sin(x*PI2*3)*Math.exp(-1.5*x) + Math.sin(x*PI2*8)*Math.exp(-3*x)*0.6 + Math.sin(x*PI2*20)*Math.exp(-8*x)*0.1}, desc: "ã€NEWã€‘ä½ã„å‘¨æ³¢æ•°ã«æˆåˆ†ãŒé›†ã¾ã£ãŸæ¯éŸ³ã€Œã‚¦ãƒ¼ã€ã€‚ã“ã‚‚ã£ãŸãƒ™ãƒ¼ã‚¹ã‚µã‚¦ãƒ³ãƒ‰ã«æœ€é©ã€‚" },
        { name: "Real Vocal 'Eh' (å£°ã‚¨ãƒ¼)", func: (t)=>{let x=fract(t); return Math.sin(x*PI2*5)*Math.exp(-2*x) + Math.sin(x*PI2*17)*Math.exp(-5*x)*0.4 + Math.sin(x*PI2*24)*Math.exp(-8*x)*0.2}, desc: "ã€NEWã€‘ã‚¢ãƒ¼ã¨ã‚¤ãƒ¼ã®ä¸­é–“çš„ãªæ¯éŸ³ã€Œã‚¨ãƒ¼ã€ã€‚ã‚·ãƒ³ã‚»ãƒªãƒ¼ãƒ‰ã«ã‚ˆãåˆã†å£°ã€‚" },
        { name: "Real Vocal 'Oh' (å£°ã‚ªãƒ¼)", func: (t)=>{let x=fract(t); return Math.sin(x*PI2*5)*Math.exp(-2*x) + Math.sin(x*PI2*9)*Math.exp(-3*x)*0.5 + Math.sin(x*PI2*22)*Math.exp(-8*x)*0.1}, desc: "ã€NEWã€‘ã‚¢ãƒ¼ã¨ã‚¦ãƒ¼ã®ä¸­é–“çš„ãªæ¯éŸ³ã€Œã‚ªãƒ¼ã€ã€‚åŠ›å¼·ã„åˆå”±ã®ã‚ˆã†ãªå£°ã€‚" },
        { name: "Fibonacci (ãƒ•ã‚£ãƒœãƒŠãƒƒãƒ)", func: (t)=>{let v=0,n=1,p=1;for(let i=0;i<8;i++){v+=Math.sin(t*PI2*n)/n;let temp=n;n+=p;p=temp;}return v*0.5}, desc: "ãƒ•ã‚£ãƒœãƒŠãƒƒãƒæ•°åˆ—(1,2,3,5,8...)ã®å€éŸ³ã‚’åŠ ç®—ã€‚è‡ªç„¶ç•Œã®æ³•å‰‡ã«åŸºã¥ã„ãŸã€æœ‰æ©Ÿçš„ã§ä¸æ€è­°ãªãƒªãƒ¼ãƒ‰éŸ³ã€‚" },
        { name: "Prime Series (ç´ æ•°)", func: (t)=>{let p=[2,3,5,7,11,13,17,19,23,29];let v=0;p.forEach(k=>v+=Math.sin(t*PI2*k)/k);return v*0.5}, desc: "ç´ æ•°å€éŸ³ï¼ˆ2,3,5,7...ï¼‰ã®ã¿ã‚’åŠ ç®—ã€‚æ•´æ•°å€éŸ³ã®ä¸­ã§ã€Œå‰²ã‚Šåˆ‡ã‚Œãªã„ã€æˆåˆ†ã ã‘ãŒæ®‹ã‚Šã€ç‹¬ç‰¹ã®ç²—ã•ãŒã‚ã‚‹ãƒ™ãƒ¼ã‚¹éŸ³ã€‚" },
        { name: "Pink Noise (1/f ã‚†ã‚‰ã)", func: (t)=>{let v=0;for(let k=1;k<64;k++)v+=Math.sin(t*PI2*k + Math.random()*PI2)/Math.sqrt(k);return v*0.4}, desc: "1/fã‚†ã‚‰ãã‚’æŒã¤ãƒ”ãƒ³ã‚¯ãƒã‚¤ã‚ºï¼ˆãƒ«ãƒ¼ãƒ—ä»•æ§˜ï¼‰ã€‚ãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºã‚ˆã‚ŠæŸ”ã‚‰ã‹ãã€Lo-Fiãªãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚„ãƒ‘ãƒƒãƒ‰ã®ç©ºæ°—æ„Ÿã«æœ€é©ã€‚" },
        { name: "Win Sync (ãƒˆãƒ¼ã‚­ãƒ³ã‚°)", func: (t)=>Math.sin(t*PI2*10)*(1-Math.cos(t*PI2))*.5, desc: "çª“é–¢æ•°ã‚’ã‹ã‘ãŸã‚·ãƒ³ã‚¯éŸ³ã§ã™ã€‚ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ã‚ãšã«ã€ãƒˆãƒ¼ã‚­ãƒ³ã‚°ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚ˆã†ãªéŸ³ã‚’ä½œã‚Œã¾ã™ã€‚" },
        { name: "Sinc (ãƒ–ãƒªãƒƒã‚¯ã‚¦ã‚©ãƒ¼ãƒ«)", func: (t)=>sinc((t-.5)*20), desc: "Sincé–¢æ•°ã€‚éå¸¸ã«ç¡¬ãã€ãƒ‡ã‚¸ã‚¿ãƒ«ãªè³ªæ„ŸãŒç‰¹å¾´ã§ã™ã€‚" },
        { name: "Bitcrush (ãƒ“ãƒƒãƒˆè½ã¡)", func: (t)=>Math.floor(Math.sin(t*PI2)*5)/5, desc: "éšæ®µçŠ¶ã«ã‚«ã‚¯ã‚«ã‚¯ã•ã›ãŸéŸ³ã§ã™ã€‚è§£åƒåº¦ã®ä½ã„ã€ãƒãƒªãƒãƒªã¨ã—ãŸLo-Fiãªãƒ‡ã‚¸ã‚¿ãƒ«éŸ³ã§ã™ã€‚" },
        { name: "Robotic Step (ãƒ­ãƒœãƒƒãƒˆ)", func: (t)=>{let s=8; return Math.floor(Math.sin(t*PI2)*s)/s}, desc: "æŒ¯å¹…ã‚’éšæ®µçŠ¶ã«é‡å­åŒ–ã—ãŸã‚µã‚¤ãƒ³æ³¢ã€‚ãƒ“ãƒƒãƒˆã‚¯ãƒ©ãƒƒã‚·ãƒ£ãƒ¼ã‚’é€šã—ãŸã‚ˆã†ãªãƒ­ãƒœãƒƒãƒˆãƒœã‚¤ã‚¹é¢¨ã§ã™ã€‚" },
        { name: "Bytebeat (ãƒ“ãƒƒãƒˆæ¼”ç®—)", func: (t)=>{let s=Math.floor(t*4096); return ((s&(s>>8))%256)/128-1}, desc: "ãƒ“ãƒƒãƒˆæ¼”ç®—(t & t>>8)ã§ç”Ÿæˆã•ã‚ŒãŸæ³¢å½¢ã€‚ãƒ•ã‚¡ãƒŸã‚³ãƒ³ãŒãƒã‚°ã£ãŸã‚ˆã†ãªã€å‘¨æœŸçš„ãªãƒ‡ã‚¸ã‚¿ãƒ«ãƒã‚¤ã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚" }
    ]
};

// --- MODULATION LIBRARY (30 Types / High-Res) ---
const MOD_LIB = [
    { name: "-- None --", type: "none", desc: "ãƒ¢ã‚¸ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚" },
    
    // Phase Mods
    { name: "Shepard Phase (ç„¡é™ä¸Šæ˜‡)", type: "phase", func: (t,a)=>t + a*Math.sin(t*PI2*(1+a*10))*0.1, desc: "ä½ç›¸ã«ãƒ•ãƒ©ã‚¯ã‚¿ãƒ«ãªå¤‰æ›ã‚’ã‹ã‘ã€éŸ³ç¨‹ãŒå¤‰ã‚ã‚‰ãªã„ã®ã«å€éŸ³ãŒç„¡é™ã«ä¸Šæ˜‡ã—ç¶šã‘ã‚‹ã‚ˆã†ãªéŒ¯è¦šåŠ¹æœï¼ˆã‚·ã‚§ãƒ‘ãƒ¼ãƒ‰ãƒˆãƒ¼ãƒ³ï¼‰ã‚’ä½œã‚Šã¾ã™ã€‚" },
    { name: "Exponential FM (æŒ‡æ•°FM)", type: "phase", func: (t,a)=>t + Math.exp(Math.sin(t*PI2)*a*3)*0.1, desc: "ä½ç›¸ã‚’æŒ‡æ•°é–¢æ•°çš„ã«æ­ªã¾ã›ã‚‹FMã€‚é€šå¸¸ã®FMã‚ˆã‚Šå¤‰åŒ–ãŒæ€¥æ¿€ã§ã€æ‚²é³´ã®ã‚ˆã†ãªé‹­ã„é‡‘å±éŸ³å¤‰åŒ–ã‚’ç”Ÿã¿ã¾ã™ã€‚" },
    { name: "Mirror Quantize (é¡é¢é‡å­åŒ–)", type: "phase", func: (t,a)=>{let s=2+(1-a)*50; return Math.abs(t - Math.floor(t*s)/s)*2}, desc: "æ™‚é–“è»¸ã‚’éšæ®µçŠ¶ã«ã™ã‚‹éš›ã€ä½™ã£ãŸéƒ¨åˆ†ã‚’åˆ‡ã‚Šæ¨ã¦ãšã«æŠ˜ã‚Šè¿”ã—ã¾ã™ã€‚éå¸¸ã«è¤‡é›‘ãªãƒ‡ã‚¸ã‚¿ãƒ«ãƒã‚¤ã‚ºã§ã€ã‚°ãƒªãƒƒãƒã‚µã‚¦ãƒ³ãƒ‰ã«æœ€é©ã§ã™ã€‚" },
    { name: "Formant Squeeze (ä¸­å¿ƒåœ§ç¸®)", type: "phase", func: (t,a)=>{let w=0.5*(1-a); return (t>0.5-w && t<0.5+w) ? (t-(0.5-w))/(2*w) : 0}, desc: "æ³¢å½¢ã®ä¸¡ç«¯ã‚’ä¸­å¤®ã«å‘ã‹ã£ã¦åœ§ç¸®ã—ã€éš™é–“ã‚’ã‚¼ãƒ­åŸ‹ã‚ã—ã¾ã™ã€‚æ“¬ä¼¼çš„ã«æ³¢é•·ãŒçŸ­ããªã‚Šã€ãƒ¯ã‚¦ãƒšãƒ€ãƒ«ã®ã‚ˆã†ãªã€Œãƒ¯ã‚¦ã€ã¨ã„ã†å¤‰åŒ–ã«ãªã‚Šã¾ã™ã€‚" },
    { name: "Time Mirror (æ™‚é–“åè»¢)", type: "phase", func: (t,a)=>(a>0.5 && t>0.5) ? 1-t : t, desc: "æ³¢å½¢ã®å¾ŒåŠã‚’å‰åŠã®é¡å†™ã—ï¼ˆåè»¢ï¼‰ã«ã—ã¾ã™ã€‚ã‚«ã‚ªã‚¹ãªæ³¢å½¢ãŒä¸€ç¬ã§ã‚·ãƒ³ãƒ¡ãƒˆãƒªãƒ¼ã«ãªã‚Šã€ä¸æ€è­°ãªå€éŸ³ãŒç”Ÿã¾ã‚Œã¾ã™ã€‚" },
    { name: "Disperser (ãƒ¬ãƒ¼ã‚¶ãƒ¼)", type: "phase", func: (t,a)=>t+Math.sin(t*PI2)*a*0.2, desc: "ã‚ªãƒ¼ãƒ«ãƒ‘ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ã«ã‚ˆã‚‹ä½ç›¸ã®ã‚ºãƒ¬ï¼ˆChirpï¼‰ã‚’åŠ ãˆã¾ã™ã€‚ã€Œãƒ“ãƒ§ãƒƒã€ã¨ã„ã†ã‚¦ã‚§ãƒƒãƒˆãªã‚¢ã‚¿ãƒƒã‚¯æ„Ÿã‚’ä½œã‚Šã¾ã™ã€‚" },
    { name: "FM (Metal / ã‚°ãƒ­ã‚¦ãƒ«)", type: "phase", func: (t,a)=>t+Math.sin(t*PI2)*a*3.0, desc: "åŸºæœ¬ã®FMï¼ˆå‘¨æ³¢æ•°å¤‰èª¿ï¼‰ã§ã™ã€‚å€¤ã‚’ä¸Šã’ã‚‹ã¨é‡‘å±çš„ãªéŸ¿ããŒåŠ ã‚ã‚Šã€Skrillexé¢¨ã®ã‚°ãƒ­ã‚¦ãƒ«ãƒ™ãƒ¼ã‚¹ã«ãªã‚Šã¾ã™ã€‚" },
    { name: "Hard Sync (å¼·åŒæœŸ)", type: "phase", func: (t,a)=>t*(1+a*8), desc: "æ³¢å½¢ã®å‘¨æœŸã‚’å¼·åˆ¶çš„ã«ãƒªã‚»ãƒƒãƒˆã—ã¦ãƒ”ãƒƒãƒã‚’ä¸Šã’ã¾ã™ã€‚ã€Œã‚®ãƒ¥ã‚¤ãƒ¼ãƒ³ã€ã¨ã„ã†é‹­ã„ãƒªãƒ¼ãƒ‰éŸ³ã®å®šç•ªã§ã™ã€‚" },
    { name: "PWM (ãƒ‘ãƒ«ã‚¹å¹…)", type: "phase", func: (t,a)=>t+a*0.5, desc: "æ³¢å½¢ã®èª­ã¿å‡ºã—ä½ç½®ã‚’ã‚ºãƒ©ã—ã¾ã™ã€‚çŸ©å½¢æ³¢ã§ä½¿ã†ã¨ãƒ‘ãƒ«ã‚¹å¹…å¤‰èª¿ï¼ˆPWMï¼‰ã«ãªã‚Šã¾ã™ãŒã€ä»–ã®æ³¢å½¢ã§ã‚‚ã‚³ãƒ¼ãƒ©ã‚¹åŠ¹æœãŒå‡ºã¾ã™ã€‚" },
    { name: "Bend Warp (ä¼¸ç¸®)", type: "phase", func: (t,a)=>Math.pow(t,Math.pow(2,(a-.5)*4)), desc: "æ³¢å½¢å…¨ä½“ã‚’å·¦å³ã«ä¼¸ç¸®ã•ã›ã¾ã™ã€‚Serumã®Warpãƒ¢ãƒ¼ãƒ‰ã«è¿‘ã„ã€ç²˜ã‚Šã®ã‚ã‚‹å¤‰åŒ–ã‚’ä½œã‚Šã¾ã™ã€‚" },
    { name: "Quantize Time (S&H)", type: "phase", func: (t,a)=>{let s=2+(1-a)*100;return Math.floor(t*s)/s}, desc: "æ™‚é–“è»¸ã‚’éšæ®µçŠ¶ã«ã—ã¾ã™ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼†ãƒ›ãƒ¼ãƒ«ãƒ‰ï¼‰ã€‚æ˜”ã®ãƒ‡ã‚¸ã‚¿ãƒ«æ¥½å™¨ã®ã‚ˆã†ãªã€ã‚¬ãƒ©ã‚¬ãƒ©ã—ãŸç²—ã„éŸ³ã«ãªã‚Šã¾ã™ã€‚" },

    // Shape / Post Mods
    { name: "Crossover Dist (ã‚¯ãƒ­ã‚¹ã‚ªãƒ¼ãƒãƒ¼)", type: "post", func: (v,t,a)=>(Math.abs(v)<a*0.5)?0:v, desc: "æ³¢å½¢ãŒã‚¼ãƒ­ã‚’æ¨ªåˆ‡ã‚‹ç¬é–“ã ã‘ä¿¡å·ã‚’ä¸­æŠœã‘ã•ã›ã¾ã™ã€‚Bç´šã‚¢ãƒ³ãƒ—ã®æ­ªã¿ã®ã‚ˆã†ãªã€ã‚¶ãƒ©ã‚¶ãƒ©ã¨ã—ãŸæ±šã‚ŒãŸè³ªæ„Ÿã€‚" },
    { name: "Sineify (ã‚µã‚¤ãƒ³åŒ–)", type: "post", func: (v,t,a)=>Math.sin(v*Math.PI*(1-a*0.5)), desc: "ã©ã‚“ãªæ³¢å½¢ã‚‚ã€é©ç”¨é‡ã‚’ä¸Šã’ã‚‹ã¨å¾ã€…ã«ã‚µã‚¤ãƒ³æ³¢ã¸ã¨ä¸¸ã¾ã£ã¦ã„ãé€†ã‚µãƒãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‚æ¿€ã—ã„éŸ³ã‚’ä¸€ç¬ã§ã‚µãƒ–ãƒ™ãƒ¼ã‚¹åŒ–ã§ãã¾ã™ã€‚" },
    { name: "Fold Chebyshev (å¤šé …å¼æŠ˜è¿”)", type: "post", func: (v,t,a)=>cheby(Math.floor(1+a*5), v), desc: "ãƒã‚§ãƒ“ã‚·ã‚§ãƒ•å¤šé …å¼ã‚’ç”¨ã„ãŸéŸ³æ¥½çš„ãªæŠ˜ã‚Šè¿”ã—æ­ªã¿ã€‚å˜ç´”ãªFoldã‚ˆã‚Šå€éŸ³ãŒæ¿ã‚‰ãšã€West Coastç³»ã®ä¸Šå“ãªå€éŸ³ãŒä»˜åŠ ã•ã‚Œã¾ã™ã€‚" },
    { name: "Rectify Inverted (åè»¢æ•´æµ)", type: "post", func: (v,t,a)=>-1*Math.abs(v)*(1+a), desc: "æ³¢å½¢ã®ãƒã‚¤ãƒŠã‚¹å´ã‚’ãƒ—ãƒ©ã‚¹ã«æŠ˜ã‚Šè¿”ã—ãŸå¾Œã€ã•ã‚‰ã«å…¨ä½“ã‚’åè»¢ã•ã›ã¾ã™ã€‚é€šå¸¸ã®Rectifyã‚ˆã‚Šéæ¿€ã§ã€çªãåˆºã•ã‚‹ã‚ˆã†ãªãƒªãƒ¼ãƒ‰éŸ³ã«ãªã‚Šã¾ã™ã€‚" },
    { name: "Pulseify (ãƒ‘ãƒ«ã‚¹åŒ–)", type: "post", func: (v,t,a)=>(v > (a-0.5)*2) ? 1 : -1, desc: "ã©ã‚“ãªæ³¢å½¢ã§ã‚‚ã€ã—ãã„å€¤ã‚’è¶…ãˆãŸã‚‰ã€Œ1ã‹-1ã€ã«ã—ã¦ã—ã¾ã„ã¾ã™ã€‚è¤‡é›‘ãªæ³¢å½¢ã‚’ç„¡ç†ã‚„ã‚ŠçŸ©å½¢æ³¢ã«ã™ã‚‹éæ¿€ãªã‚³ãƒ³ãƒ—åŠ¹æœã€‚" },
    { name: "Reverb (Comb / ç©ºé–“)", type: "post", func: (v,t,a)=>v+0.6*Math.sin(t*PI2+a*20), desc: "éå¸¸ã«çŸ­ã„é…å»¶ã‚’è¶³ã—åˆã‚ã›ã‚‹ã‚³ãƒ ãƒ•ã‚£ãƒ«ã‚¿åŠ¹æœã§ã™ã€‚Serumã®Reverb Filterã®ã‚ˆã†ãªã€é‡‘å±çš„ã§ç©ºé–“çš„ãªåºƒãŒã‚Šã‚’ä½œã‚Šã¾ã™ã€‚" },
    { name: "Diffusion (æ‹¡æ•£ãƒã‚¤ã‚º)", type: "post", func: (v,t,a)=>{ 
        // Improved All-Pass Diffusion
        let spread = Math.sin(t*PI2*50*(1+a));
        return v + spread*a*0.05; 
    }, desc: "ä½ç›¸ã‚’å¾®ç´°ã«éœ‡ã‚ã›ã€éŸ³ã®è¼ªéƒ­ã‚’ã¼ã‹ã—ã¾ã™ã€‚ãƒªãƒãƒ¼ãƒ–ã®ã€Œç©ºæ°—æ„Ÿã€ã‚„ã€é›†å›£ã§é³´ã‚‰ã—ãŸã‚ˆã†ãªåšã¿ã‚’ä»˜åŠ ã—ã¾ã™ã€‚" },
    { name: "Bitcrush (ãƒ“ãƒƒãƒˆè½ã¡)", type: "post", func: (v,t,a)=>{if(a==0)return v;let s=Math.pow(2,1+(1-a)*16);return Math.floor(v*s)/s}, desc: "æ³¢å½¢ã‚’éšæ®µçŠ¶ã«ã—ã¦è§£åƒåº¦ã‚’ä¸‹ã’ã¾ã™ã€‚ãƒãƒªãƒãƒªã¨ã—ãŸLo-Fiã§ãƒ‡ã‚¸ã‚¿ãƒ«ãªç ´å£ŠéŸ³ã‚’åŠ ãˆã¾ã™ã€‚" },
    { name: "Fold Dist (åŸºæœ¬æŠ˜è¿”)", type: "post", func: (v,t,a)=>Math.sin(v*(1+a*5)), desc: "æ³¢å½¢ãŒä¸Šé™ã‚’è¶…ãˆãŸã‚‰æŠ˜ã‚Šè¿”ã—ã¾ã™ï¼ˆWavefolderï¼‰ã€‚West Coastã‚·ãƒ³ã‚»ã®ã‚ˆã†ãªã€è¤‡é›‘ã§è±Šã‹ãªå€éŸ³ã‚’ç”Ÿã¿ã¾ã™ã€‚" },
    { name: "Saturator (å¤ªã•)", type: "post", func: (v,t,a)=>Math.tanh(v*(1+a*10)), desc: "éŸ³é‡ã‚’æŒã¡ä¸Šã’ã¦ã‹ã‚‰tanhé–¢æ•°ã§æ½°ã—ã¾ã™ã€‚ã‚¢ãƒŠãƒ­ã‚°æ©Ÿæã®ã‚ˆã†ãªå¤ªã•ã¨ã€è‡ªç„¶ãªæ­ªã¿ã‚’åŠ ãˆã¾ã™ã€‚" },
    { name: "Dimension Exp (ç–‘ä¼¼ã‚¹ãƒ†ãƒ¬ã‚ª)", type: "post", func: (v,t,a)=>v - 0.5 * Math.sin((t-0.001)*PI2)*a, desc: "åŸéŸ³ã¨ã€ã‚ãšã‹ã«é…ã‚‰ã›ã¦åè»¢ã—ãŸéŸ³ã‚’ãƒŸãƒƒã‚¯ã‚¹ã—ã¾ã™ã€‚ç‰¹å®šã®å‘¨æ³¢æ•°ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã€éŸ³ãŒå¥¥ã«å¼•ã£è¾¼ã‚“ã ã‚ˆã†ãªç©ºé–“çš„ãªéŸ¿ãã«ãªã‚Šã¾ã™ã€‚" },
    { name: "Slew Limiter (LPF)", type: "post", func: (v,t,a)=>(v + Math.sin((t-a*0.01)*PI2))/2, desc: "æ³¢å½¢ã®æ€¥æ¿€ãªå¤‰åŒ–ï¼ˆå´–ï¼‰ã‚’æ¤œçŸ¥ã—ã¦ã€æ–œé¢ã«ãªã‚‰ã—ã¾ã™ã€‚å®Ÿè³ªçš„ãªãƒ­ãƒ¼ãƒ‘ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ã—ã¦æ©Ÿèƒ½ã—ã€éŸ³ã‚’ãƒã‚¤ãƒ«ãƒ‰ã«ã—ã¾ã™ã€‚" }
];

const SLOT_COUNT = 3;

// =========================================================
// 2. UI LOGIC (Safe Initialization)
// =========================================================
window.onload = function() {
    // Dropdowns
    const catSelect = document.getElementById('catSelect');
    Object.keys(WAVE_LIB).forEach(c => {
        let o = document.createElement('option'); o.value = c; o.innerText = c; catSelect.appendChild(o);
    });

    // Slots
    const modContainer = document.getElementById('modContainer');
    for (let i = 0; i < SLOT_COUNT; i++) {
        let div = document.createElement('div');
        div.className = 'mod-slot';
        div.innerHTML = `
            <div class="slot-header">
                <select id="type_${i}" class="slot-select" onchange="onModSelect(${i})">
                    ${MOD_LIB.map((m, idx) => `<option value="${idx}">${m.name}</option>`).join('')}
                </select>
                <label class="link-check">
                    <input type="checkbox" id="link_${i}" checked onchange="updateState()">
                    <span>LINK Y</span>
                </label>
            </div>
            <div id="modDesc_${i}" class="mod-desc">--</div>
            <input type="range" id="amt_${i}" min="0" max="100" value="0" oninput="updateState()">
        `;
        modContainer.appendChild(div);
    }
    
    // Explicit Init
    catSelect.selectedIndex = 0;
    updateWaveList();
    for(let i=0; i<SLOT_COUNT; i++) onModSelect(i, false);
    
    // Start Loop
    requestAnimationFrame(animateScope);
};

function updateWaveList() {
    const cat = document.getElementById('catSelect').value;
    const wSel = document.getElementById('waveSelect');
    wSel.innerHTML = "";
    if (WAVE_LIB[cat]) {
        WAVE_LIB[cat].forEach((w, i) => {
            let o = document.createElement('option'); o.value = i; o.innerText = w.name; wSel.appendChild(o);
        });
        wSel.selectedIndex = 0;
    }
    updateWaveDesc();
    updateState();
}

function updateWaveDesc() {
    const cat = document.getElementById('catSelect').value;
    const idx = document.getElementById('waveSelect').value;
    if (WAVE_LIB[cat] && WAVE_LIB[cat][idx]) {
        document.getElementById('waveDesc').innerText = WAVE_LIB[cat][idx].desc;
    }
}

function updateState() { /* handled by loop */ }

function onModSelect(i, autoRaise=true) {
    let idx = document.getElementById(`type_${i}`).value;
    let slot = document.getElementsByClassName('mod-slot')[i];
    let desc = document.getElementById(`modDesc_${i}`);
    let slider = document.getElementById(`amt_${i}`);
    
    desc.innerText = MOD_LIB[idx].desc;
    if(MOD_LIB[idx].type !== 'none') {
        slot.classList.add('active');
        if(autoRaise && slider.value == 0) slider.value = 50; 
    } else {
        slot.classList.remove('active');
        if(autoRaise) slider.value = 0;
    }
    updateState();
}

function resetAll() {
    document.getElementById('catSelect').selectedIndex = 0;
    updateWaveList();
    for(let i=0; i<SLOT_COUNT; i++) {
        document.getElementById(`type_${i}`).value = 0;
        document.getElementById(`amt_${i}`).value = 0;
        onModSelect(i);
    }
    document.getElementById('lfoToggle').checked = false;
    document.getElementById('posSlider').value = 0;
}

function randomize() {
    resetAll();
    const cats = Object.keys(WAVE_LIB);
    document.getElementById('catSelect').value = cats[Math.floor(Math.random() * cats.length)];
    updateWaveList();
    const wOpts = document.getElementById('waveSelect').options;
    document.getElementById('waveSelect').selectedIndex = Math.floor(Math.random() * wOpts.length);
    
    const numMods = Math.floor(Math.random() * 2) + 1;
    for(let i=0; i<numMods; i++) {
        const rIdx = Math.floor(Math.random() * (MOD_LIB.length - 1)) + 1;
        document.getElementById(`type_${i}`).value = rIdx;
        document.getElementById(`amt_${i}`).value = Math.floor(Math.random()*60)+20;
        onModSelect(i);
    }
    updateState();
}

function setPreset(key) {
    resetAll();
    const set = (slot, name, val) => {
        let idx = MOD_LIB.findIndex(m => m.name.includes(name));
        if(idx>=0) {
            document.getElementById(`type_${slot}`).value = idx;
            document.getElementById(`amt_${slot}`).value = val;
            onModSelect(slot);
        }
    };
    if(key==='growl') {
        document.getElementById('catSelect').value = "ã€é‡‘å±ã€‘FM / ãƒ¡ã‚¿ãƒªãƒƒã‚¯";
        updateWaveList();
        set(0, "FM", 60); set(1, "Bitcrush", 30); set(2, "Reverb", 40);
    } else if(key==='pad') {
        document.getElementById('catSelect').value = "ã€å’ŒéŸ³ã€‘ã‚³ãƒ¼ãƒ‰ / ã‚ªãƒ«ã‚¬ãƒ³";
        updateWaveList();
        document.getElementById('waveSelect').selectedIndex = 7; 
        set(0, "Tremolo", 30); set(1, "Diffusion", 20);
    } else if(key==='acid') {
        document.getElementById('catSelect').value = "ã€åŸºæœ¬ã€‘ã‚¢ãƒŠãƒ­ã‚° / ãƒ™ãƒ¼ã‚·ãƒƒã‚¯";
        updateWaveList();
        document.getElementById('waveSelect').selectedIndex = 5; 
        set(0, "Fold Dist", 50); set(1, "Saturator", 40);
    }
}

// =========================================================
// 3. ENGINE (Sample Generation - Tuned for Performance)
// =========================================================
function calculateSample(t_in, y_in, waveFunc, slotParams, oversampleAmount) {
    // 8x Oversampling for Export (High Quality)
    // 1x Oversampling for Preview (Low CPU)
    const OS = oversampleAmount;
    let sum = 0;
    
    for (let o = 0; o < OS; o++) {
        // Sub-sample time offset
        let t = t_in + (o / OS) * (1.0 / 2048.0); 
        
        // Pre-Mods
        for(let i=0; i<SLOT_COUNT; i++) {
            if(slotParams[i].type === 'phase') {
                let effectiveAmt = slotParams[i].linked ? (slotParams[i].amt * y_in) : slotParams[i].amt;
                t = slotParams[i].func(t, effectiveAmt);
            }
        }
        
        // Safe Wrap for JS
        t = fract(t);

        let v = waveFunc(t);

        // Post-Mods
        for(let i=0; i<SLOT_COUNT; i++) {
            if(slotParams[i].type === 'post') {
                let effectiveAmt = slotParams[i].linked ? (slotParams[i].amt * y_in) : slotParams[i].amt;
                v = slotParams[i].func(v, t, effectiveAmt);
            }
        }
        sum += v;
    }
    
    return sum / OS;
}

function getSlotParams() {
    let params = [];
    for(let i=0; i<SLOT_COUNT; i++) {
        let idx = document.getElementById(`type_${i}`).value;
        let amt = document.getElementById(`amt_${i}`).value / 100;
        let linked = document.getElementById(`link_${i}`).checked;
        params.push({
            type: MOD_LIB[idx].type,
            func: MOD_LIB[idx].func,
            amt: amt,
            linked: linked
        });
    }
    return params;
}

// =========================================================
// 4. VISUALIZER & AUDIO
// =========================================================
const canvas = document.getElementById('scope');
const ctx = canvas.getContext('2d');

function animateScope() {
    const w = canvas.width;
    const h = canvas.height;
    
    const catSelect = document.getElementById('catSelect');
    const waveSelect = document.getElementById('waveSelect');
    if (!catSelect.value || !waveSelect.value) {
        requestAnimationFrame(animateScope);
        return;
    }

    ctx.fillStyle = "#222"; ctx.fillRect(0,0,w,h);
    ctx.strokeStyle = "#444"; ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();

    const cat = catSelect.value;
    const wIdx = waveSelect.value;
    const waveFunc = WAVE_LIB[cat][wIdx].func;
    const slots = getSlotParams();

    // LFO Logic
    const lfoOn = document.getElementById('lfoToggle').checked;
    const posSlider = document.getElementById('posSlider');
    
    let y = 0;
    if (lfoOn) {
        const time = Date.now()/1000;
        y = (Math.sin(time*2)+1)/2; 
        posSlider.value = y * 100;
        posSlider.disabled = true;
    } else {
        y = posSlider.value / 100;
        posSlider.disabled = false;
    }

    ctx.strokeStyle = "#e91e63";
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    // Use 1x OS for visualizer (Speed)
    for(let i=0; i<w; i++) {
        let t = i/w;
        let v = calculateSample(t, y, waveFunc, slots, 1);
        
        if(v>1) v=1; if(v<-1) v=-1;
        let dy = h/2 - (v * h/2.5);
        if(i===0) ctx.moveTo(i, dy); else ctx.lineTo(i, dy);
    }
    ctx.stroke();
    
    ctx.fillStyle = "#fff"; ctx.font = "10px monospace";
    ctx.fillText(`Pos: ${y.toFixed(2)}`, 5, 12);
    
    requestAnimationFrame(animateScope);
}

let audioCtx = null;
let scriptNode = null;
let isPlaying = false;

function togglePreview() {
    const btn = document.getElementById('previewBtn');
    
    if (isPlaying) {
        if(scriptNode) { scriptNode.disconnect(); scriptNode = null; }
        isPlaying = false;
        btn.classList.remove('playing');
        btn.innerText = "ğŸ”Š è©¦è´ã™ã‚‹ (Preview)";
        return;
    }

    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    scriptNode = audioCtx.createScriptProcessor(4096, 1, 1);
    
    let phase = 0;
    const freq = 55.0; 
    const sr = audioCtx.sampleRate;
    const phaseIncr = freq / sr;

    scriptNode.onaudioprocess = function(e) {
        const out = e.outputBuffer.getChannelData(0);
        
        const cat = document.getElementById('catSelect').value;
        const wIdx = document.getElementById('waveSelect').value;
        const waveFunc = WAVE_LIB[cat][wIdx].func;
        const slots = getSlotParams();
        
        const y = document.getElementById('posSlider').value / 100;
        const vol = document.getElementById('volSlider').value / 100;

        for (let i = 0; i < out.length; i++) {
            // Use 1x OS for Real-time Audio (Performance)
            let val = calculateSample(phase, y, waveFunc, slots, 1);
            if(val>1) val=1; if(val<-1) val=-1; if(isNaN(val)) val=0;
            
            out[i] = val * 0.5 * vol;
            
            phase += phaseIncr;
            // Use fract() equivalent logic for phase wrap
            if (phase >= 1.0) phase -= 1.0;
        }
    };

    scriptNode.connect(audioCtx.destination);
    isPlaying = true;
    btn.classList.add('playing');
    btn.innerText = "â¹ åœæ­¢ (Stop)";
}

// =========================================================
// 5. WAV EXPORT
// =========================================================
function generateWav() {
    const btn = document.getElementById('dlBtn');
    const status = document.getElementById('status');
    btn.disabled = true;
    status.innerText = "ãŸã ã„ã¾8å€ã‚ªãƒ¼ãƒãƒ¼ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã§æ›¸ãå‡ºã—ä¸­ã§ã™...ã—ã°ã‚‰ããŠã¾ã¡ãã ã•ã„ã€‚";

    setTimeout(() => {
        try {
            const cat = document.getElementById('catSelect').value;
            const wIdx = document.getElementById('waveSelect').value;
            let wName = WAVE_LIB[cat][wIdx].name;
            
            // Clean filename
            wName = wName.replace(/[^\w\s-]/g, '').trim().replace(/\s+/g, '_');
            
            const waveFunc = WAVE_LIB[cat][wIdx].func;
            const slots = getSlotParams();

            const TABLE_SIZE = 2048;
            const NUM_FRAMES = 256;
            const SR = 44100;
            const totalSamples = TABLE_SIZE * NUM_FRAMES;
            
            const buffer = new Float32Array(totalSamples);
            let maxPeak = 0;

            for(let f=0; f<NUM_FRAMES; f++) {
                let y = f / (NUM_FRAMES - 1);
                for(let i=0; i<TABLE_SIZE; i++) {
                    let t = i / TABLE_SIZE;
                    // Use 8x OS for Export (Quality)
                    let v = calculateSample(t, y, waveFunc, slots, 8);
                    buffer[f*TABLE_SIZE + i] = v;
                    if(Math.abs(v) > maxPeak) maxPeak = Math.abs(v);
                }
            }

            if(maxPeak > 0) {
                let gain = 0.944 / maxPeak;
                for(let i=0; i<totalSamples; i++) buffer[i] *= gain;
            }

            const wavData = encodeWAV(buffer, SR);
            const blob = new Blob([wavData], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `WT_${wName}_Gen.wav`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            status.innerText = "Done!";
        } catch(e) {
            alert(e);
        }
        btn.disabled = false;
    }, 50);
}

function encodeWAV(samples, sampleRate) {
    const bufferLength = samples.length * 4;
    const view = new DataView(new ArrayBuffer(44 + bufferLength));
    const writeString = (v, o, s) => { for(let i=0;i<s.length;i++) v.setUint8(o+i, s.charCodeAt(i)); };

    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + bufferLength, true);
    writeString(view, 8, 'WAVE');
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 3, true); 
    view.setUint16(22, 1, true); 
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 4, true);
    view.setUint16(32, 4, true);
    view.setUint16(34, 32, true);
    writeString(view, 36, 'data');
    view.setUint32(40, bufferLength, true);

    let offset = 44;
    for(let i=0; i<samples.length; i++) {
        view.setFloat32(offset, samples[i], true);
        offset += 4;
    }
    return view;
}
</script>
</body>
</html>
